# УСТАНОВКА ПРОГРАММЫ

## Конфигурация оборудования

Развертывание программного обеспечения производится на виртуальных машинах (серверах) под управлением ОС СН «Astra Linux Special Edition», релиз «Смоленск» (версия 1.6). 

Пример состава оборудования и параметров его конфигурации представлен в таблице  1.

Таблица 1 – Пример конфигурации оборудования

| № п/п | Имя сервера (hostname) | IP-адрес сервера | Назначение сервера |
|:-----:|:-----------------------|:-----------------|:-------------------|
| 1 | back-07 | 10.9.153.217 | Сервер установки, используется для развертывания приложений через Ansible, на нем же расположен репозиторий с пакетами СПО |
| 2 | back-08 или dev9-postgresql.gisdemo.kt | 10.9.153.218 | Сервер с базами данных PostgreSQL |
| 3 | back-11 или dev9-swift.gisdemo.kt | 10.9.153.221 | Сервер с файловым хранилищем S3 |
| 4 | back-12 или dev9-rabbitmq.gisdemo.kt | 10.9.153.222 | Сервер очередей RabbitMQ |
| 5 | back-20 или dev9-services1.gisdemo.kt | 10.9.153.230 | Сервер с сервисами СПО |

## Состав дистрибутива

Дистрибутив программы размещается на отчуждаемых носителях. Состав и назначение носителей данных представлены в таблице 2.

Таблица 2 – Состав дистрибутива

| № п/п | Носитель данных (диск) | Состав носителя данных (диска) | Адрес развертывания
|:-----:|:-----------------------|:-----------------|:-------------------|
| 1 | centr-4.4_repo_disk_1 | Репозиторий СПО	back-07
| 2 | centr-4.4_static_disk_2 | Статические файлы (тайлы карт)	back-07
| 3 | centr-4.4_installer_disk_3 | Установочные скрипты для системы управления конфигурациями Ansible | back-07
| 4 | centr-4.4_installer_disk_4 | Установочные скрипты вспомогательной части СПО | back-07
| 5 | centr-4.4_installer_disk_5 | Репозиторий программного компонента «Отображение морской обстановки» | back-07
| 6 | centr-4.4_installer_disk_6 | Репозиторий программного компонента «Отображение морской обстановки» | back-07
| 7 | centr-4.4_installer_disk_7 | Репозиторий программного компонента «Моделирование действий сил ВМФ» | back-08, back-11, back-12, back-20
| 8 | centr-4.4_installer_disk_8 | Репозиторий программного компонента «Моделирование действий сил ВМФ» | back-08, back-11, back-12, back-20

## Установка общего системного ПО

Установка программного обеспечения на каждой из виртуальных машин (серверов) производится пользователем с правами администратора (root), входящим в группу sudo.  

1. Перед началом установки СПО на каждом из серверов следует убедиться, что в файле `/etc/apt/sources.list`, содержащем список источников, из которых могут быть загружены необходимые пакеты, присутствуют ссылки на следующие репозитории:  
   * Astra Linux 1.6 SE;
   * Astra Linux 1.6 SE Update 6;
   * Astra Linux 1.6 SE dev;
   * Astra Linux 1.6 SE Update 6 dev.
    
    Для этого следует выполнить команду:
    ```
    cat /etc/apt/sources.list
    ```
1. Установить пакеты, необходимые для развертывания СПО.  

    Для этого на каждом из серверов следует выполнить команду:
    ```
    sudo apt update && sudo apt install -y python3-all python3-pip python3-venv ansible apache2
    ```
1. На каждом из серверов внести изменения в файл конфигурации веб-сервера apache2.
 
    Для этого в файле `/etc/apache2/apache2.conf` найти строку:
 
    `#AstraMode on`

    и заменить ее на строку:
 
    `AstraMode off`

1. Перезапустить веб-сервер apache2, выполнив команду:
    ```
    sudo systemctl restart apache2
    ```


## Установка основной части СПО (диски 1—3)

П р и м е ч а н и е. Описанные ниже действия выполняются на сервере установки (back-07).

1. Скопировать содержимое диска 1 в директорию `/var/www/html/`.

    Ниже представлен пример процесса копирования содержимого отчуждаемого носителя на локальный компьютер.

    1. Вставить носитель в соответствующее устройство ввода-вывода: для флеш-накопителя – в USB-порт, для оптического диска – в устройство чтения CD/DVD-ROM.

    1. Для определения параметров подключенного носителя ввести команду:
    ```
    sudo fdisk –l
    ```
    Результатом выполнения команды будет список устройств хранения данных, присутствующих в системе. Из данного списка необходимо определить имя файла, ассоциируемого системой с подключенным отчуждаемым носителем, например `/dev/sdc1`.

    1. Для создания точки монтирования ввести команду:
    ```
    mkdir /tmp/centr
    ```
    1. Для монтирования носителя ввести команду: 
    ```
    mount /dev/sdc1 /tmp/centr
    ```

    1. Для копирования данных с отчуждаемого носителя в соответствующую директорию, например `/var/www/html/`, ввести команду:
    ```
    sudo cp -r /tmp/centr/* /var/www/html/
    ```
    Дождаться завершения процесса копирования содержимого носителя.

    1. Для размонтирования носителя выполнить команду:
    ```
    umount /tmp/centr
    ```
    Извлечь носитель информации из устройства ввода-вывода.

    1. Для удаления точки монтирования ввести команду:
    ```
    rmdir /tmp/centr
    ```
1. Скопировать содержимое диска 2 в директорию `/var/www/html/` указанным выше способом.

1. Скопировать содержимое диска 3 указанным выше способом в домашнюю директорию пользователя (`/home/$USER/`).

1. Распаковать архив с установочными скриптами, выполнив команду:
    ```
    tar xvzf /home/$USER/installer.tar.gz /home/$USER/
    ```
1. Установить права, необходимые для чтения файлов, веб-серверу apache2, работающему с конфигурационным файлом, содержащим установки «по-умолчанию», выполнив команды:

    ```
    sudo chown -R www-data:www-data /var/www/html/*
    sudo chmod -R 744 /var/www/html/*
    ```

1. Установить модуль mergedeep для python3.
 
    Для этого перейти в директорию с установочными скриптами Ansible:
    ```
    cd /home/$USER/installer/
    ```
    и выполнить команды:
    ```
    cd mergedeep
    pip3 install .
    cd ..
    ```
1. Создать ssh-ключ, выполнив команду:
    ```
    ssh-keygen -t rsa
    ```
1. Скопировать полученный ключ на каждый из серверов следующей командой, где hostname — имя сервера, username — имя пользователя с правами администратора (root), входящего в группу sudo данного сервера:
    ```
    ssh-copy-id username@hostname
    ```
1. В файле `ansible.cfg` указать имя пользователя, добавив в него приведенные ниже строки, где username — имя пользователя с правами администратора (root), входящего в группу sudo на каждом из серверов.
    ```
    [defaults]
    remote_user = username
    ```
1. Произвести настройку файла `inventory/rti/hosts.yml`, указав актуальные адреса серверов, а также остальные параметры в соответствии с комментариями, помеченными символом «#» внутри файла.

    Ниже приведен пример содержимого файла `inventory/rti/hosts.yml`.
    ```yml
    all:
      hosts:
        # Сервер базы данных Postgres
        dev9-postgresql.gisdemo.kt:
        # Сервер очередей Rabbitmq
        dev9-rabbitmq.gisdemo.kt:
        # Файловое хранилище S3
        dev9-swift.gisdemo.kt:
        # Сервисы СПО
        dev9-services1.gisdemo.kt:
      vars:
        # Имя пользователя с правами sudo на каждом из серверов
        remote_user: user 
        # Удалять старые версии сервисов
        PRODUCT_services_purge: True 
        REPO_NEXUS_REPOS:
            # Адреса доступных репозиториев ОС СН Astra Linux SE
          - "http://art.rd.aorti.ru/repository/astra_16/"
          - "http://art.rd.aorti.ru/repository/astra_16-20200722/"
          - "http://art.rd.aorti.ru/repository/astra_16-dev/"
          - "http://art.rd.aorti.ru/repository/astra_16-20200722-dev/"
        SYSTEM_user_passwd: '12345678'
        PRODUCT_apt_repo:
            # IP адрес или URL сервера, на котором мы редактируем этот файл  
          - url: "[trusted=yes] http://10.10.4.133/repo"
            distribution: './'
            components: ""
      children:
        services: # Группа для хостов на которые будут ставится сервисы
          hosts:
            dev9-services1.gisdemo.kt:
        swift: # Группа хостов для свифт-хранилища данных
          hosts:
            dev9-swift.gisdemo.kt:
        rabbitmq: # rabbitmq-сервер
          hosts:
            dev9-rabbitmq.gisdemo.kt:
        postgres: # Сервер базы данных
          hosts:
            dev9-postgresql.gisdemo.kt:
            
    ```
1. Установить СПО и требуемые зависимости, выполнив следующие команды:
    ``` 
    ansible-playbook -i inventory/rti playbooks/swift-deploy.yml
    ansible-playbook -i inventory/rti playbooks/rabbitmq-deploy.yml
    ansible-playbook -i inventory/rti playbooks/postgres-deploy.yml
    ansible-playbook -i inventory/rti playbooks/services-deploy.yml
    ```

1. Установить сетевой протокол аутентификации auth, выполнив команду:
    ```
    sudo apt install auth
    ```
1. Настроить переменные окружения `KRB5_KTNAME` и `KRB5_CLIENT_KTNAME`, указав их значения в файле `.env`, находящемся в папке с приложением `/opt/sitronics-kt/auth/`.

    Ниже приведен пример содержимого файла .env:
    ```
    ENV_FOR_DYNACONF=default
    KRB5_KTNAME=/opt/1krontech-int-83t411.int.aorti.tech.keytab
    KRB5_CLIENT_KTNAME=/opt/sitronics-kt/auth/auth_user.keytab
    ```
1. Создать необходимые keytab-файлы.

    Ниже приведен пример команд для пользователя user_kt1@INT.AORTI.TECH:
    ```
    ktutil -kt /path/to/auth.keytab
    addent -password -p user_kt1@INT.AORTI.TECH -k 6 -e RC4-HMAC
    write_kt /path/to/client.keytab
    ```
    П р и м е ч а н и е. Сервис auth запускается от имени пользователя svc_auth, поэтому keytab-файлы должны быть доступны пользователю svc_auth для чтения.

1. Запустить сервис аутентификации, выполнив команду:
    ```
    sudo systemctl start auth@default
    ```
1. Запустить синхронизацию с сервисом оптимизации оперативной памяти, выполнив следующие команды:
    ```
    cd /opt/sitronics-kt/auth/
    . venv/bin/activate
    python3 sync.py &
    ```
1. Проконтролировать список приложений после установки сервисов, выполнив команду:
    ```
    sudo systemctl | grep kt-
    ```

## Установка вспомогательной части СПО (диски 4—8)

1. Для развертывания вспомогательной части СПО необходимо на сервере back-11 установить и настроить следующие пакеты:
    * postgis;
    * postgresql-9.6-postgis-2.3;
    * postgresql-9.6-postgis-2.3-scripts (devel-smolensk);
    * postgresql-9.6-postgis-scripts (devel-smolensk);
    * liblwgeom-2.3-0;
    * libsfcgal1;
    * pgadmin3.

    Для этого требуется выполнить команду:
    ```
    sudo apt update && sudo apt install -y postgis postgresql-9.6-postgis-2.3 postgresql-9.6-postgis-2.3-scripts postgresql-9.6-postgis-scripts liblwgeom-2.3-0 libsfcgal1 pgadmin3
    ```
    П р и м е ч а н и е. Пароль для просмотра базы данных `fgtkmcby`.

1. В файле `/etc/postgresql/9.6/main/postgresql.conf` на сервере back 11 необходимо выполнить редактирование 94-й строки, заменив `localhost` на `*` и перезапустить PostgreSQL, выполнив команду:

    ```
    systemctl restart postgresql
    ```
1. Скопировать содержимое дисков 4—8 в домашнюю директорию пользователя (`/home/$USER/`) на каждый из серверов в соответствии с адресами развертывания, указанными в таблице 2.

    Пример процесса копирования приведен выше.

1. После завершения процесса копирования необходимо убедиться, что на соответствующих виртуальных машинах находиться следующие файлы:
    
    На сервере back-07: 
    * install_back-07.sh (диск 4);
    * chart-server.deb (диск 5);
    * chart_data.7z (диск 5);
    * java_mc.7z (диск 5);
    * tiles.7z (диск 5);
    * vector.7z (диск 5);
    * vector-ms.deb (диск 5);
    * S-57_DAY_BRIGHT.7z (диск 6);
    * venv_mc.7z (диск 7).
    
    На сервере back-08:
    * install_back-08.sh (диск 4);
    * autoroute.deb (диск 7);
    * venv_mc.7z (диск 7).
    
    На сервере back-11:
    * install_back-11.sh (диск 4);
    * db_modelcm.7z (диск 8).
    
    На сервере back-12:
    * install_back-12.sh (диск 4);
    * modelcm.deb (диск 7);
    * venv_mc.7z (диск 7).
    
    На сервере back-20:
    * install_back-20.sh (диск 4);
    * iss-mmp.deb (диск 7);
    * venv_mc.7z (диск 7).
    
1. Задать необходимые разрешения на выполнение установочного скрипта на всех виртуальных машинах, выполнив следующие команды:

    * на сервере back-07:
    ```
    sudo chmod +x install_back-07.sh
    ```
    * на сервере back-08:
    ```
    sudo chmod +x install_back-08.sh
    ```
    * на сервере back-11:
    ```
    sudo chmod +x install_back-11.sh
    ```
    * на сервере back-12:
    ```
    sudo chmod +x install_back-12.sh
    ```
    * на сервере back-20:
    ```
    sudo chmod +x install_back-20.sh
    ```
1. Запустить развертывание компонентов вспомогательной части СПО на соответствующих виртуальных машинах, выполнив следующие команды:

    * на сервере back-07:
    ```
    ./install_back-07.sh
    ```
    * на сервере back-08:
    ```
    ./install_back-08.sh
    ```
    * на сервере back-11:
    ```
    ./install_back-11.sh
    ```
    * на сервере back-12:
    ```
    ./install_back-12.sh
    ```
    * на сервере back-20:
    ```
    ./install_back-20.sh
    ```

    Компоненты ПК «Веб-сервер расширенных режимов отображения» устанавливаются в каталог `/opt/centr/`.

1. Выполнить проверку настройки конфигурационных файлов на каждой из виртуальных машин. 

    Ниже приведен пример возможного содержимого файлов конфигурации:

    * на сервере back-07 в файле `/opt/centr/vector_ms/settings.ini`:
    ```
    [server_base]
    host = 10.9.153.221
    
    [server_web]
    host = 10.9.153.217
    ```
    
    * на сервере back-12 в файле `/opt/centr/modelcm/settings.ini`:
    ```
    [server_base]
    host = 10.9.153.221
    
    [server_web]
    host = 10.9.153.222
    
    [server_iss_mmp]
    host = 10.9.153.230
    
    [server_iss_map]
    host = 10.9.153.217
    
    [server_router]
    host = 10.9.153.218
    ```
    
    * на сервере back-20 в файле `/opt/centr/iss_mmp/settings.ini`:
    ```
    [server_web]
    host = 10.9.153.230
    ```  

# ЗАПУСК СИСТЕМЫ И ПРОВЕРКА РАБОТОСПОСОБНОСТИ

Для запуска установленной программы в командной строке интернет-браузера необходимо набрать адрес соответствующего сервера, например:
http://dev9-services1.gisdemo.kt

В случае успешного запуска на экране отобразится главное окно программы.
Проверка работоспособности происходит при последовательной проверке функционала «Слои», «Выбрать подложку», «Сделать снимок», «Построить маршрут», «Увеличить», «Уменьшить», «Переключить режим».
Если проверка функционала пройдена успешно, то программа считается работоспособной.
